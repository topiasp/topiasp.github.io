<html>
<header>
</header>
<body>
<p>
# Kirjastot
source("https://topiasp.github.io/projects/project3/createMap.R")
library(pxweb)
library(jsonlite)
library(reshape)

# Esimerkkidata osinkojan pörssiyhtiöistä saaneiden osuus kunnittain: 5.1.3 - Pääomatulona verotetut osingot (listatut yhtiöt) (TVL 33 §) / 1 - Asiakkaita

dat <-  get_pxweb_data(url = "http://vero2.stat.fi/PXWeb/api/v1/fi/Vero/Henkiloasiakkaiden_tuloverot/lopulliset/Alue/191_alue.px",
                       dims = list(Verovuosi = c('2015'),
                                   Erä = c('HT_T_10','HT_PT_5_1_3'),
                                   Alue = c('*'),
                                   "Tuloluokka *" = c('T000'),
                                   Tunnusluvut = c('N')),
                       clean = TRUE)


# Haetaan kuntakoodit erikseen


datMeta <- readLines("http://vero2.stat.fi/PXWeb/api/v1/fi/Vero/Henkiloasiakkaiden_tuloverot/lopulliset/Alue/191_alue.px",
                     warn=F,encoding='UTF-8')

koodisto <- fromJSON(datMeta)
koodisto <- data.frame(kuntakoodi=tmp$variables$values[[3]],kuntanimi=tmp$variables$valueTexts[[3]],stringsAsFactors = F)

# Pelkät kuntakoodit eli tiputetaan maakunnat & koko maa
koodisto <- subset(koodisto,nchar(kuntakoodi)==3)

# Yhdistetään data & koodisto (samalla tippuu muut aluetasot)
dat <- merge(dat,koodisto,by.x='Alue',by.y='kuntanimi')

# Inhimillisemmät nimet
levels(dat$Erä) <- c('Asiakkaita','Pörssiyhtiöistä osinkoja')

# Tiputetaan turhat muuttujat

dat <- dat[,c('Alue','Erä','values','kuntakoodi')]

# Pitkästä leveäksi, jotta voidaan laskea osuus
dat <- cast(dat,Alue+kuntakoodi~Erä,value='values')

# Lasketaan osuus
dat$osinkoja_pörssiyhtiöstä_osuus <- round(dat$`Pörssiyhtiöistä osinkoja`/dat$Asiakkaita*100,2)

# Oikea järjestys (kuntakoodi,kuntanimi,muuttujat 1-n)
dat <- dat[,c(2,1,3:ncol(dat))]
# Tehdään kartta tulostus working directoryyn
createMap(dat)

</p>
</body>
</html>